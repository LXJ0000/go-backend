## 需求
### 阅读、点赞、收藏功能
1. 阅读数 每次打开加1 存储真实数量 暂时不考虑压热度
2. **点赞和收藏都有取消功能** 取消点赞、移除收藏夹
3. 收藏中有收藏夹
4. 表结构设计 3个cnt在同一行 读友好 否则可能需要3次磁盘IO 由于插入是不一定相邻
5. 做好缓存，防止超高的QPS压垮数据库，map:key{cnt1, cnt2, cnt3}
6. 使用消息队列引入阅读记录功能  history_record

### 榜单模型
1. 展示一个热点榜单，展示五十条信息
2. **性能**和**可用性**都非常高，问题关键点：
   - 什么样的才算是热点
   - 如何计算热点
   - 热点必然带来高并发，如何保证性能
     - 热点功能奔溃，如何减低对整个系统的影响
#### 什么是热点
1. 综合考虑用户的各种行为：阅读数、点赞、收藏
2. 综合考虑时间的衰减特性：发布时间、用户点赞、收藏时间
3. 权重因子

##### HackNews模型
点赞数最重要，而后热度随时间衰减
##### Reddit模型
考虑核心因素：点赞、反对、发布时间

#### 是否实时计算
考虑 **榜单数据是否需要实时计算**？ 

实时计算：`ZSET`

##### 实时计算难点
1. 全表扫描 + 全局排序

##### 解决方案 - 异步定时计算
- 每隔一段时间计算一次热榜。间隔时间可控，间隔时间越短，实时性越高
- 异步的情况下，计算时间依旧不能太久
  - 如何设计缓存，保证极好的查询性能
  - 如何保证可用性，保证任何情况下都能拿到热榜数据

定时器 - 计算热榜的算法实现  
算法的核心是依赖于点赞数，因此需要找到每一篇文章的点赞数，而后计算对于的`score`  
考虑到文章数非常多，采用批量计算方法
1. 每次从数据库拉取一批，找到对应点赞数，计算`score`
2. 使用数据结构维护前100，比较，淘汰，加入
3. 全部计算完毕，缓存

如何设计查询接口：本地缓存 + Redis

现在存在的问题 如果我们部署了多个实例 那么有可能多个实例同时执行热榜计算任务  
控制节点只在一个实例计算，使用分布式锁方案，保证只有一个协程能够拿到锁 拿到则执行 否则不执行

lock的时候，知道运行时间为timeout，约定过期时间一致并且没有续约
unlock的时候，可以重试，也没必要 因为存在过期时间

该方法只能同一时刻只有一个实例在计算，没法保证过一段时间在计算，解决方案 采用分布式任务的**间隔时间**，计算完毕后也不释放 等待过期  
存在问题，没算成功咋办  另一个方法，一个实例直接锁住，始终是有一个实例在计算

### 本地缓存替换 Redis
    - 定义 CodeCache 接口，目前只有 CodeRedisCache
    - 提供基于本地缓存实现的 CodeLocalCache
    - 保证**单机**并发安全
### 注册、登陆后缓存用户信息
### 长短 Token [ok]
### 退出登录
### 微信登陆
### 高可用短信服务平台
### 布隆过滤器
### 日志模块 [ok]
### 配置模块 [ok]
### 装饰器


### 伙伴关系系统
### 评论系统 
### 搜索服务
- 方便用户快速找到所需内容
- 增加广告收入

实现的功能：
1. 搜索具体的用户
2. 搜索文章
3. 搜索评论

影响因素：点赞、收藏、时间、评论数、打赏、投放
